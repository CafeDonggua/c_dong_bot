# Feature Specification: 內嵌檢索與快速回覆

**Feature Branch**: `003-embedding-fast-replies`  
**Created**: 2026-02-02  
**Status**: Done  
**Input**: User description: "我新增了OPENAI_EMBEDDING_KEY這個API到.env裡面，其對應的是OPENAI API的text-embedding-3-small模型，你可以加入embedding的功能進入目前的程式 然後請尋找關於透過Telegram 應用程式串接API變成個人助理的做法做為參考，加快目前的執行效能 現在每一次提問或是聊天都會等上約莫6次的回覆時長，太慢了 應該要視情況決定是否要直接回覆或是調用工具，而非每次都需要輪循的做法，GOAP並不是這樣濫用的"
**語言**: 本模板與輸出內容一律使用正體中文

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 快速直接回覆 (Priority: P1)

使用者在 Telegram 私聊或群組中發問一般聊天或簡單問題時，助理能直接回覆，不需要多次等待或重複往返。

**Why this priority**: 目前每次互動需等待多次回覆，體感過慢；先改善常見聊天的等待時間可立即提升可用性。

**Independent Test**: 只實作直接回覆決策與輸出，即可測得回覆速度明顯縮短且內容可被理解。

**Acceptance Scenarios**:

1. **Given** 使用者提出一般聊天問題，**When** 系統判定不需外部工具，**Then** 直接在同一輪互動中回覆且不觸發任何工具流程
2. **Given** 使用者連續提問兩次一般問題，**When** 系統可在第一次就完成回覆，**Then** 第二次互動不需等待多次循環即可取得答覆

---

### User Story 2 - 語意記憶檢索輔助回答 (Priority: P2)

使用者詢問先前對話或已知內容時，助理可透過語意記憶檢索，提供更一致且可延續的回答。

**Why this priority**: 需要新增記憶檢索以提升連貫性與個人助理體驗，但可在直接回覆改善後再導入。

**Independent Test**: 僅實作記憶檢索與引用回覆，即可看到回答內容與歷史一致。

**Acceptance Scenarios**:

1. **Given** 使用者過去提供過偏好或資訊，**When** 使用者詢問相關問題，**Then** 回覆能引用先前資訊且內容一致

---

### User Story 3 - 依情境選擇是否調用工具 (Priority: P3)

使用者提出需要外部資料或操作的問題時，助理能判斷是否需要工具並只在必要時觸發。

**Why this priority**: 避免濫用多步驟流程造成等待，但仍需保留必要的工具能力。

**Independent Test**: 只實作工具調用判斷即可測得工具呼叫次數下降且對必要問題仍可完成。

**Acceptance Scenarios**:

1. **Given** 使用者提出需要外部資料的問題，**When** 系統判定必須使用工具，**Then** 只觸發一次必要工具流程並回覆結果

---

### Edge Cases

- 當語意檢索找不到相關記憶時，系統回覆「無相關資訊」並提供替代提問建議
- 當工具調用失敗或超時時，系統提供可理解的降級回覆並避免無限重試

## 測試與驗證策略 *(mandatory)*

- **自動化測試範圍**: 直接回覆決策邏輯、語意檢索命中與未命中行為、工具調用判斷分流
- **手動驗證步驟**: 以三類問題（一般聊天、可回憶問題、需工具問題）各測試 5 次，確認回覆輪次與內容符合預期
- **無法自動化原因**: 若效能指標需實際部署環境測量，可改以人工壓測與量測記錄方式驗證

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統 MUST 能判斷使用者問題是否需要外部工具，並在不需要時直接回覆
- **FR-002**: 系統 MUST 支援語意記憶檢索以回覆與歷史對話相關的問題
- **FR-003**: 系統 MUST 在語意檢索無結果時提供明確回覆與替代引導
- **FR-004**: 系統 MUST 避免每次互動都進入多步驟循環流程
- **FR-005**: 系統 MUST 在工具失敗或超時時提供降級回覆且不中斷對話流程
- **FR-006**: 系統 MUST 在不需要即時外部資料時優先使用本地可得的記憶內容完成檢索以降低等待

對應驗證：各 FR 的驗證以使用者故事的 Acceptance Scenarios 為準。

### Key Entities *(include if feature involves data)*

- **使用者**: 發起對話的人，包含使用者識別與偏好資訊
- **訊息**: 使用者與助理的每次輸入與輸出內容
- **對話記憶**: 可被語意檢索的歷史內容或摘要
- **工具調用**: 代表需要外部資料或操作的處理請求
- **檢索結果**: 語意檢索命中的相關內容與信心程度

## 適用範圍

- 以 Telegram 私聊或小型群組的個人助理互動為主要使用情境
- 以日常對話與個人資訊延續為主要價值場景

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 一般聊天問題的首次回覆時間中位數小於 2 秒，且 95% 的回覆在 5 秒內
- **SC-002**: 至少 80% 的一般聊天互動不觸發工具流程即可完成回覆
- **SC-003**: 含記憶檢索的問題有 90% 以上可提供與先前資訊一致的回答
- **SC-004**: 工具需要的問題在一次工具流程內完成回覆的比例達 95%

## Assumptions

- 使用者主要在 Telegram 私聊或小型群組與助理互動
- 語意檢索的資料來源為既有對話或可控的記憶內容
- 若無即時外部需求，檢索以本地可得資料為主以提升速度
- 效能指標以實際使用者互動量測為準
